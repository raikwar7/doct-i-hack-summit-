<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Nearby Hospitals</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            color: white;
            padding: 20px;
        }

        h2 {
            font-size: 26px;
            font-weight: bold;
        }

        .container {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            margin: auto;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        }

        #hospitalList {
            list-style: none;
            padding: 0;
            max-width: 600px;
            margin: auto;
        }

        .hospital-item {
            background: rgba(255, 255, 255, 0.3);
            padding: 15px;
            margin: 8px;
            border-radius: 12px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
            text-align: left;
            transition: 0.3s;
        }

        .hospital-item:hover {
            transform: scale(1.05);
        }

        .btn {
            display: inline-block;
            padding: 10px 14px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .call-btn {
            background: #27ae60;
        }

        .directions-btn {
            background: #2980b9;
        }

        .btn:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }

        .find-btn {
            background: #ff6b6b;
            padding: 12px 18px;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
        }

        .find-btn:hover {
            background: #e84118;
            transform: scale(1.1);
        }

        /* Emergency Sidebar Button */
        .emergency-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: red;
            color: white;
            padding: 15px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
        }

        .emergency-btn:hover {
            background: darkred;
        }

    </style>
</head>

<body>

    <h2>Find Nearby Hospitals üè•</h2>
    
    <div class="container">
        <label for="radius">Select Range:</label>
        <select id="radius" onchange="fetchHospitals(selectedLat, selectedLon)">
            <option value="5000">5 km</option>
            <option value="10000">10 km</option>
            <option value="15000">15 km</option>
        </select>
        <button class="find-btn" onclick="useCurrentLocation()">Use My Location</button>
        <p>Click on the map to select a location üìç</p>
        <div id="map"></div>
        <ul id="hospitalList"></ul>
    </div>

    <!-- Emergency Hospital Sidebar Button -->
    <div class="emergency-btn" onclick="fetchEmergencyHospitals()">üöë</div>

    <script>
        let map, userMarker, selectedLat, selectedLon;
        let isMapInitialized = false;

        function initMap(lat, lon) {
            if (!isMapInitialized) {
                map = L.map('map').setView([lat, lon], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                userMarker = L.marker([lat, lon]).addTo(map)
                    .bindPopup('üìç Selected Location').openPopup();

                map.on('click', function (e) {
                    selectedLat = e.latlng.lat;
                    selectedLon = e.latlng.lng;
                    updateUserMarker(selectedLat, selectedLon);
                    fetchHospitals(selectedLat, selectedLon);
                });

                isMapInitialized = true;
            } else {
                map.setView([lat, lon], 14);
                updateUserMarker(lat, lon);
            }
        }

        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    selectedLat = position.coords.latitude;
                    selectedLon = position.coords.longitude;
                    initMap(selectedLat, selectedLon);
                    fetchHospitals(selectedLat, selectedLon);
                }, error => {
                    alert("‚ö† Location access denied! Please allow location access.");
                });
            } else {
                alert("‚ö† Geolocation is not supported by this browser.");
            }
        }

        function updateUserMarker(lat, lon) {
            if (userMarker) {
                userMarker.setLatLng([lat, lon]).bindPopup('üìç Selected Location').openPopup();
            } else {
                userMarker = L.marker([lat, lon]).addTo(map).bindPopup('üìç Selected Location').openPopup();
            }
        }

        function fetchHospitals(lat, lon) {
            const range = document.getElementById('radius').value;
            fetchHospitalData(lat, lon, range, false);
        }

        function fetchEmergencyHospitals() {
            fetchHospitalData(selectedLat, selectedLon, 5000, true);
        }

        function fetchHospitalData(lat, lon, range, emergency) {
            const overpassQuery = `
                [out:json];
                (
                    node["amenity"="hospital"](around:${range}, ${lat}, ${lon});
                    node["healthcare"="hospital"](around:${range}, ${lat}, ${lon});
                );
                out center;
            `;

            fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`)
                .then(response => response.json())
                .then(data => {
                    const hospitalList = document.getElementById('hospitalList');
                    hospitalList.innerHTML = '';

                    let hospitals = data.elements.map(hospital => ({
                        name: hospital.tags.name || "Unnamed Hospital",
                        lat: hospital.lat,
                        lon: hospital.lon,
                        distance: getDistance(lat, lon, hospital.lat, hospital.lon)
                    }));

                    hospitals.sort((a, b) => a.distance - b.distance);

                    hospitals.forEach(hospital => {
                        L.marker([hospital.lat, hospital.lon], { color: emergency ? 'red' : 'blue' }).addTo(map)
                            .bindPopup(`<strong>${hospital.name}</strong><br>üìè ${hospital.distance} km away`);
                    });
                });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            return (6371 * Math.acos(Math.cos(lat1) * Math.cos(lat2) + Math.sin(lat1) * Math.sin(lat2))).toFixed(2);
        }

        useCurrentLocation();
    </script>

</body>
</html>
